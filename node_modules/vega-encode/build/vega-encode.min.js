!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-dataflow"),require("vega-scale"),require("vega-util"),require("d3-array"),require("d3-interpolate")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scale","vega-util","d3-array","d3-interpolate"],n):n(((e=e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega,e.d3,e.d3)}(this,(function(e,n,t,a,r,i){"use strict";function o(e){n.Transform.call(this,null,e)}function l(e){n.Transform.call(this,null,e)}function u(){return n.ingest({})}function s(e){return e.exit}function d(e){n.Transform.call(this,null,e)}function f(e){n.Transform.call(this,[],e)}a.inherits(o,n.Transform).transform=function(e,a){if(this.value&&!e.modified())return a.StopPropagation;var r=a.dataflow.locale(),i=a.fork(a.NO_SOURCE|a.NO_FIELDS),o=this.value,l=e.scale,u=null==e.count?e.values?e.values.length:10:e.count,s=t.tickCount(l,u,e.minstep),d=e.format||t.tickFormat(r,l,s,e.formatSpecifier,e.formatType,!!e.values),f=e.values?t.validTicks(l,e.values,s):t.tickValues(l,s);return o&&(i.rem=o),o=f.map((function(e,t){return n.ingest({index:t/(f.length-1||1),value:e,label:d(e)})})),e.extra&&o.length&&o.push(n.ingest({index:-1,extra:{value:o[0].value},label:""})),i.source=o,i.add=o,this.value=o,i},a.inherits(l,n.Transform).transform=function(e,t){var r=t.dataflow,i=t.fork(t.NO_SOURCE|t.NO_FIELDS),o=e.item||u,l=e.key||n.tupleid,d=this.value;return a.isArray(i.encode)&&(i.encode=null),d&&(e.modified("key")||t.modified(l))&&a.error("DataJoin does not support modified key function or fields."),d||(t=t.addAll(),this.value=d=a.fastmap().test(s),d.lookup=function(e){return d.get(l(e))}),t.visit(t.ADD,(function(e){var n=l(e),t=d.get(n);t?t.exit?(d.empty--,i.add.push(t)):i.mod.push(t):(d.set(n,t=o(e)),i.add.push(t)),t.datum=e,t.exit=!1})),t.visit(t.MOD,(function(e){var n=l(e),t=d.get(n);t&&(t.datum=e,i.mod.push(t))})),t.visit(t.REM,(function(e){var n=l(e),t=d.get(n);e!==t.datum||t.exit||(i.rem.push(t),t.exit=!0,++d.empty)})),t.changed(t.ADD_MOD)&&i.modifies("datum"),e.clean&&d.empty>r.cleanThreshold&&r.runAfter(d.clean),i},a.inherits(d,n.Transform).transform=function(e,n){var t=n.fork(n.ADD_REM),r=e.mod||!1,i=e.encoders,o=n.encode;if(a.isArray(o)){if(!t.changed()&&!o.every((function(e){return i[e]})))return n.StopPropagation;o=o[0],t.encode=null}var l="enter"===o,u=i.update||a.falsy,s=i.enter||a.falsy,d=i.exit||a.falsy,f=(o&&!l?i[o]:u)||a.falsy;if(n.changed(n.ADD)&&(n.visit(n.ADD,(function(n){s(n,e),u(n,e)})),t.modifies(s.output),t.modifies(u.output),f!==a.falsy&&f!==u&&(n.visit(n.ADD,(function(n){f(n,e)})),t.modifies(f.output))),n.changed(n.REM)&&d!==a.falsy&&(n.visit(n.REM,(function(n){d(n,e)})),t.modifies(d.output)),l||f!==a.falsy){var c=n.MOD|(e.modified()?n.REFLOW:0);l?(n.visit(c,(function(n){var a=s(n,e)||r;(f(n,e)||a)&&t.mod.push(n)})),t.mod.length&&t.modifies(s.output)):n.visit(c,(function(n){(f(n,e)||r)&&t.mod.push(n)})),t.mod.length&&t.modifies(f.output)}return t.changed()?t:n.StopPropagation},a.inherits(f,n.Transform).transform=function(e,r){if(null!=this.value&&!e.modified())return r.StopPropagation;var i,o,l,u,s,d=r.dataflow.locale(),f=r.fork(r.NO_SOURCE|r.NO_FIELDS),c=this.value,m=e.type||t.SymbolLegend,p=e.scale,h=+e.limit,g=t.tickCount(p,null==e.count?5:e.count,e.minstep),v=!!e.values||m===t.SymbolLegend,y=e.format||t.labelFormat(d,p,g,m,e.formatSpecifier,e.formatType,v),M=e.values||t.labelValues(p,g);return c&&(f.rem=c),m===t.SymbolLegend?(h&&M.length>h?(r.dataflow.warn("Symbol legend count exceeds limit, filtering items."),c=M.slice(0,h-1),s=!0):c=M,a.isFunction(l=e.size)?(e.values||0!==p(c[0])||(c=c.slice(1)),u=c.reduce((function(n,t){return Math.max(n,l(t,e))}),0)):l=a.constant(u=l||8),c=c.map((function(t,a){return n.ingest({index:a,label:y(t,a,c),value:t,offset:u,size:l(t,e)})})),s&&(s=M[c.length],c.push(n.ingest({index:c.length,label:`â€¦${M.length-c.length} entries`,value:s,offset:u,size:l(s,e)})))):m===t.GradientLegend?(i=p.domain(),o=t.scaleFraction(p,i[0],a.peek(i)),M.length<3&&!e.values&&i[0]!==a.peek(i)&&(M=[i[0],a.peek(i)]),c=M.map((function(e,t){return n.ingest({index:t,label:y(e,t,M),value:e,perc:o(e)})}))):(l=M.length-1,o=t.labelFraction(p),c=M.map((function(e,t){return n.ingest({index:t,label:y(e,t,M),value:e,perc:t?o(e):0,perc2:t===l?1:o(M[t+1])})}))),f.source=c,f.add=c,this.value=c,f};var c=a.fastmap({line:y,"line-radial":function(e,n,t,a){return y(n*Math.cos(e),n*Math.sin(e),a*Math.cos(t),a*Math.sin(t))},arc:M,"arc-radial":function(e,n,t,a){return M(n*Math.cos(e),n*Math.sin(e),a*Math.cos(t),a*Math.sin(t))},curve:b,"curve-radial":function(e,n,t,a){return b(n*Math.cos(e),n*Math.sin(e),a*Math.cos(t),a*Math.sin(t))},"orthogonal-horizontal":function(e,n,t,a){return"M"+e+","+n+"V"+a+"H"+t},"orthogonal-vertical":function(e,n,t,a){return"M"+e+","+n+"H"+t+"V"+a},"orthogonal-radial":function(e,n,t,a){var r=Math.cos(e),i=Math.sin(e),o=Math.cos(t),l=Math.sin(t),u=Math.abs(t-e)>Math.PI?t<=e:t>e;return"M"+n*r+","+n*i+"A"+n+","+n+" 0 0,"+(u?1:0)+" "+n*o+","+n*l+"L"+a*o+","+a*l},"diagonal-horizontal":function(e,n,t,a){var r=(e+t)/2;return"M"+e+","+n+"C"+r+","+n+" "+r+","+a+" "+t+","+a},"diagonal-vertical":function(e,n,t,a){var r=(n+a)/2;return"M"+e+","+n+"C"+e+","+r+" "+t+","+r+" "+t+","+a},"diagonal-radial":function(e,n,t,a){var r=Math.cos(e),i=Math.sin(e),o=Math.cos(t),l=Math.sin(t),u=(n+a)/2;return"M"+n*r+","+n*i+"C"+u*r+","+u*i+" "+u*o+","+u*l+" "+a*o+","+a*l}});function m(e){return e.source.x}function p(e){return e.source.y}function h(e){return e.target.x}function g(e){return e.target.y}function v(e){n.Transform.call(this,{},e)}function y(e,n,t,a){return"M"+e+","+n+"L"+t+","+a}function M(e,n,t,a){var r=t-e,i=a-n,o=Math.sqrt(r*r+i*i)/2;return"M"+e+","+n+"A"+o+","+o+" "+180*Math.atan2(i,r)/Math.PI+" 0 1 "+t+","+a}function b(e,n,t,a){var r=t-e,i=a-n,o=.2*(r+i),l=.2*(i-r);return"M"+e+","+n+"C"+(e+o)+","+(n+l)+" "+(t+l)+","+(a-o)+" "+t+","+a}function S(e){n.Transform.call(this,null,e)}v.Definition={type:"LinkPath",metadata:{modifies:!0},params:[{name:"sourceX",type:"field",default:"source.x"},{name:"sourceY",type:"field",default:"source.y"},{name:"targetX",type:"field",default:"target.x"},{name:"targetY",type:"field",default:"target.y"},{name:"orient",type:"enum",default:"vertical",values:["horizontal","vertical","radial"]},{name:"shape",type:"enum",default:"line",values:["line","arc","curve","diagonal","orthogonal"]},{name:"require",type:"signal"},{name:"as",type:"string",default:"path"}]},a.inherits(v,n.Transform).transform=function(e,n){var t=e.sourceX||m,r=e.sourceY||p,i=e.targetX||h,o=e.targetY||g,l=e.as||"path",u=e.orient||"vertical",s=e.shape||"line",d=c.get(s+"-"+u)||c.get(s);return d||a.error("LinkPath unsupported type: "+e.shape+(e.orient?"-"+e.orient:"")),n.visit(n.SOURCE,(function(e){e[l]=d(t(e),r(e),i(e),o(e))})),n.reflow(e.modified()).modifies(l)},S.Definition={type:"Pie",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"startAngle",type:"number",default:0},{name:"endAngle",type:"number",default:6.283185307179586},{name:"sort",type:"boolean",default:!1},{name:"as",type:"string",array:!0,length:2,default:["startAngle","endAngle"]}]},a.inherits(S,n.Transform).transform=function(e,n){var t,i,o,l=e.as||["startAngle","endAngle"],u=l[0],s=l[1],d=e.field||a.one,f=e.startAngle||0,c=null!=e.endAngle?e.endAngle:2*Math.PI,m=n.source,p=m.map(d),h=p.length,g=f,v=(c-f)/r.sum(p),y=r.range(h);for(e.sort&&y.sort((function(e,n){return p[e]-p[n]})),t=0;t<h;++t)o=p[y[t]],(i=m[y[t]])[u]=g,i[s]=g+=o*v;return this.value=p,n.reflow(e.modified()).modifies(l)};function x(e){return t.isContinuous(e)&&e!==t.Sequential}var k=a.toSet(["set","modified","clear","type","scheme","schemeExtent","schemeCount","domain","domainMin","domainMid","domainMax","domainRaw","domainImplicit","nice","zero","bins","range","rangeStep","round","reverse","interpolate","interpolateGamma"]);function D(e){n.Transform.call(this,null,e),this.modified(!0)}function w(e,n,r){t.isLogarithmic(e)&&(Math.abs(n.reduce((function(e,n){return e+(n<0?-1:n>0?1:0)}),0))!==n.length&&r.warn("Log scale domain includes zero: "+a.stringValue(n)));return n}function O(e,n,r){return a.isFunction(e)&&(n||r)?t.interpolateRange(e,T(n||[0,1],r)):e}function T(e,n){return n?e.slice().reverse():e}function A(e){n.Transform.call(this,null,e)}a.inherits(D,n.Transform).transform=function(e,n){var o=n.dataflow,l=this.value,u=function(e){var n,r=e.type,i="";if(r===t.Sequential)return t.Sequential+"-"+t.Linear;(function(e){const n=e.type;return t.isContinuous(n)&&n!==t.Time&&n!==t.UTC&&(e.scheme||e.range&&e.range.length&&e.range.every(a.isString))})(e)&&(n=e.rawDomain?e.rawDomain.length:e.domain?e.domain.length+ +(null!=e.domainMid):0,i=2===n?t.Sequential+"-":3===n?t.Diverging+"-":"");return(i+r||t.Linear).toLowerCase()}(e);for(u in l&&u===l.type||(this.value=l=t.scale(u)()),e)if(!k[u]){if("padding"===u&&x(l.type))continue;a.isFunction(l[u])?l[u](e[u]):o.warn("Unsupported scale property: "+u)}return function(e,n,r){var o=e.type,l=n.round||!1,u=n.range;if(null!=n.rangeStep)u=function(e,n,r){e!==t.Band&&e!==t.Point&&a.error("Only band and point scales support rangeStep.");var i=(null!=n.paddingOuter?n.paddingOuter:n.padding)||0,o=e===t.Point?1:(null!=n.paddingInner?n.paddingInner:n.padding)||0;return[0,n.rangeStep*t.bandSpace(r,o,i)]}(o,n,r);else if(n.scheme&&(u=function(e,n,r){var i,o,l=n.schemeExtent;a.isArray(n.scheme)?o=t.interpolateColors(n.scheme,n.interpolate,n.interpolateGamma):(i=n.scheme.toLowerCase(),(o=t.scheme(i))||a.error("Unrecognized scheme name: "+n.scheme));return r=e===t.Threshold?r+1:e===t.BinOrdinal?r-1:e===t.Quantile||e===t.Quantize?+n.schemeCount||5:r,t.isInterpolating(e)?O(o,l,n.reverse):a.isFunction(o)?t.quantizeInterpolator(O(o,l),r):e===t.Ordinal?o:o.slice(0,r)}(o,n,r),a.isFunction(u))){if(e.interpolator)return e.interpolator(u);a.error(`Scale type ${o} does not support interpolating color schemes.`)}if(u&&t.isInterpolating(o))return e.interpolator(t.interpolateColors(T(u,n.reverse),n.interpolate,n.interpolateGamma));u&&n.interpolate&&e.interpolate?e.interpolate(t.interpolate(n.interpolate,n.interpolateGamma)):a.isFunction(e.round)?e.round(l):a.isFunction(e.rangeRound)&&e.interpolate(l?i.interpolateRound:i.interpolate);u&&e.range(T(u,n.reverse))}(l,e,function(e,n,i){let o=n.bins;if(o&&!a.isArray(o)){let n=e.domain(),t=n[0],i=a.peek(n),l=null==o.start?t:o.start,u=null==o.stop?i:o.stop,s=o.step;s||a.error("Scale bins parameter missing step property."),l<t&&(l=s*Math.ceil(t/s)),u>i&&(u=s*Math.floor(i/s)),o=r.range(l,u+s/2,s)}o?e.bins=o:e.bins&&delete e.bins;e.type===t.BinOrdinal&&(o?n.domain||n.domainRaw||(e.domain(o),i=o.length):e.bins=e.domain());return i}(l,e,function(e,n,r){var i=function(e,n,t){return n?(e.domain(w(e.type,n,t)),n.length):-1}(e,n.domainRaw,r);if(i>-1)return i;var o,l,u=n.domain,s=e.type,d=n.zero||void 0===n.zero&&function(e){const n=e.type;return!e.bins&&(n===t.Linear||n===t.Pow||n===t.Sqrt)}(e);if(!u)return 0;x(s)&&n.padding&&u[0]!==a.peek(u)&&(u=function(e,n,r,i,o,l){var u=Math.abs(a.peek(r)-r[0]),s=u/(u-2*i),d=e===t.Log?a.zoomLog(n,null,s):e===t.Sqrt?a.zoomPow(n,null,s,.5):e===t.Pow?a.zoomPow(n,null,s,o||1):e===t.Symlog?a.zoomSymlog(n,null,s,l||1):a.zoomLinear(n,null,s);return(n=n.slice())[0]=d[0],n[n.length-1]=d[1],n}(s,u,n.range,n.padding,n.exponent,n.constant));(d||null!=n.domainMin||null!=n.domainMax||null!=n.domainMid)&&(o=(u=u.slice()).length-1||1,d&&(u[0]>0&&(u[0]=0),u[o]<0&&(u[o]=0)),null!=n.domainMin&&(u[0]=n.domainMin),null!=n.domainMax&&(u[o]=n.domainMax),null!=n.domainMid&&(((l=n.domainMid)<u[0]||l>u[o])&&r.warn("Scale domainMid exceeds domain min or max.",l),u.splice(o,0,l)));e.domain(w(s,u,r)),s===t.Ordinal&&e.unknown(n.domainImplicit?t.scaleImplicit:void 0);n.nice&&e.nice&&e.nice(!0!==n.nice&&t.tickCount(e,n.nice)||null);return u.length}(l,e,o))),n.fork(n.NO_SOURCE|n.NO_FIELDS)},a.inherits(A,n.Transform).transform=function(e,t){var a=e.modified("sort")||t.changed(t.ADD)||t.modified(e.sort.fields)||t.modified("datum");return a&&t.source.sort(n.stableCompare(e.sort)),this.modified(a),t};var C=["y0","y1"];function L(e){n.Transform.call(this,null,e)}function z(e,n,t,a,r){for(var i,o=(n-e.sum)/2,l=e.length,u=0;u<l;++u)(i=e[u])[a]=o,i[r]=o+=Math.abs(t(i))}function P(e,n,t,a,r){for(var i,o=1/e.sum,l=0,u=e.length,s=0,d=0;s<u;++s)(i=e[s])[a]=l,i[r]=l=o*(d+=Math.abs(t(i)))}function E(e,n,t,a,r){for(var i,o,l=0,u=0,s=e.length,d=0;d<s;++d)(i=+t(o=e[d]))<0?(o[a]=u,o[r]=u+=i):(o[a]=l,o[r]=l+=i)}L.Definition={type:"Stack",metadata:{modifies:!0},params:[{name:"field",type:"field"},{name:"groupby",type:"field",array:!0},{name:"sort",type:"compare"},{name:"offset",type:"enum",default:"zero",values:["zero","center","normalize"]},{name:"as",type:"string",array:!0,length:2,default:C}]},a.inherits(L,n.Transform).transform=function(e,t){var r,i,o,l,u=e.as||C,s=u[0],d=u[1],f=n.stableCompare(e.sort),c=e.field||a.one,m="center"===e.offset?z:"normalize"===e.offset?P:E;for(r=function(e,n,t,a){var r,i,o,l,u,s,d,f,c,m=[],p=function(e){return e(u)};if(null==n)m.push(e.slice());else for(r={},i=0,o=e.length;i<o;++i)u=e[i],s=n.map(p),(d=r[s])||(r[s]=d=[],m.push(d)),d.push(u);for(s=0,c=0,l=m.length;s<l;++s){for(d=m[s],i=0,f=0,o=d.length;i<o;++i)f+=Math.abs(a(d[i]));d.sum=f,f>c&&(c=f),t&&d.sort(t)}return m.max=c,m}(t.source,e.groupby,f,c),i=0,o=r.length,l=r.max;i<o;++i)m(r[i],l,c,s,d);return t.reflow(e.modified()).modifies(u)},e.axisticks=o,e.datajoin=l,e.encode=d,e.legendentries=f,e.linkpath=v,e.pie=S,e.scale=D,e.sortitems=A,e.stack=L,Object.defineProperty(e,"__esModule",{value:!0})}));